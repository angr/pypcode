<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>decompiler: The Basic SLEIGH Interface</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">decompiler
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">SLEIGH</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">The Basic SLEIGH Interface </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>To use SLEIGH as a library within an application, there are basically five classes that you need to be aware of.</p>
<ul>
<li><a class="el" href="sleighAPIbasic.html#sleightranslate">Translate (or Sleigh)</a></li>
<li><a class="el" href="sleighAPIbasic.html#sleighassememit">AssemblyEmit</a></li>
<li><a class="el" href="sleighAPIbasic.html#sleighpcodeemit">PcodeEmit</a></li>
<li><a class="el" href="sleighAPIbasic.html#sleighloadimage">LoadImage</a></li>
<li><a class="el" href="sleighAPIbasic.html#sleighcontext">ContextDatabase</a></li>
</ul>
<h1><a class="anchor" id="sleightranslate"></a>
Translate (or Sleigh)</h1>
<p>The core SLEIGH class is <a class="el" href="classSleigh.html">Sleigh</a>, which is derived from the interface, <a class="el" href="classTranslate.html" title="The interface to a translation engine for a processor. ">Translate</a>. In order to instantiate it in your code, you need a <a class="el" href="classLoadImage.html" title="An interface into a particular binary executable image. ">LoadImage</a> object, and a <a class="el" href="classContextDatabase.html" title="An interface to a database of disassembly/decompiler context information. ">ContextDatabase</a> object. The load image is responsible for retrieving instruction bytes, based on address, from a binary executable. The context database provides the library extra mode information that may be necessary to do the disassembly or translation. This can be used, for instance, to specify that an x86 binary is running in 32-bit mode, or to specify that an ARM processor is running in THUMB mode. Once these objects are built, the <a class="el" href="classSleigh.html">Sleigh</a> object can be immediately instantiated.</p>
<div class="fragment"><div class="line">LoadImageBfd *loader;</div><div class="line"><a class="code" href="classContextDatabase.html">ContextDatabase</a> *context;</div><div class="line"><a class="code" href="classTranslate.html">Translate</a> *trans;</div><div class="line"></div><div class="line"><span class="comment">// Set up the loadimage</span></div><div class="line"><span class="comment">// Providing an executable name and architecture</span></div><div class="line"><span class="keywordtype">string</span> loadimagename = <span class="stringliteral">&quot;x86testcode&quot;</span>;</div><div class="line"><span class="keywordtype">string</span> bfdtarget= <span class="stringliteral">&quot;default&quot;</span>;</div><div class="line"></div><div class="line">loader = <span class="keyword">new</span> LoadImageBfd(loadimagename,bfdtarget);</div><div class="line">loader-&gt;open();       <span class="comment">// Load the executable from file</span></div><div class="line"></div><div class="line">context = <span class="keyword">new</span> <a class="code" href="classContextInternal.html">ContextInternal</a>();   <span class="comment">// Create a processor context</span></div><div class="line"></div><div class="line">trans = <span class="keyword">new</span> <a class="code" href="classSleigh.html">Sleigh</a>(loader,context);  <span class="comment">// Instantiate the translator</span></div></div><!-- fragment --><p>Once the <a class="el" href="classSleigh.html">Sleigh</a> object is in hand, the only required initialization step left is to inform it of the ".sla" file. The file is in XML format and needs to be read in using SLEIGH's built-in XML parser. The following code accomplishes this.</p>
<div class="fragment"><div class="line"><span class="keywordtype">string</span> sleighfilename = <span class="stringliteral">&quot;specfiles/x86.sla&quot;</span>;</div><div class="line"><a class="code" href="classDocumentStorage.html">DocumentStorage</a> docstorage;</div><div class="line"><a class="code" href="classElement.html">Element</a> *sleighroot = docstorage.openDocument(sleighfilename)-&gt;getRoot();</div><div class="line">docstorage.registerTag(sleighroot);</div><div class="line">trans-&gt;<a class="code" href="classTranslate.html#af8e71e9a9477e9a91be400ecca565df5">initialize</a>(docstorage);  <span class="comment">// Initialize the translator</span></div></div><!-- fragment --><h1><a class="anchor" id="sleighassememit"></a>
AssemblyEmit</h1>
<p>In order to do disassembly, you need to derive a class from <a class="el" href="classAssemblyEmit.html" title="Abstract class for emitting disassembly to an application. ">AssemblyEmit</a>, and implement the method <em>dump</em>. The library will call this method exactly once, for each instruction disassembled.</p>
<p>This routine simply needs to decide how (and where) to print the corresponding portion of the disassembly. For instance,</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>AssemblyRaw : <span class="keyword">public</span> <a class="code" href="classAssemblyEmit.html">AssemblyEmit</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classAssemblyEmit.html#afdb4c90bde30480659ad4eaa49bd1487">dump</a>(<span class="keyword">const</span> <a class="code" href="classAddress.html">Address</a> &amp;addr,<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;mnem,<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;body) {</div><div class="line">    addr.<a class="code" href="classAddress.html#abc8be0370dd8397596c06a5f68bcc8e8">printRaw</a>(cout);</div><div class="line">    cout &lt;&lt; <span class="stringliteral">&quot;: &quot;</span> &lt;&lt; mnem &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; body &lt;&lt; endl;</div><div class="line">  }</div><div class="line">};</div></div><!-- fragment --><p>This is a minimal implementation that simply dumps the disassembly straight to standard out. Once this object is instantiated, the <a class="el" href="classSleigh.html">Sleigh</a> object can use it to write out assembly via the <a class="el" href="classTranslate.html#ac97443bb89e0c6bfb68caf9f48a8c85d" title="Disassemble a single machine instruction. ">Translate::printAssembly()</a> method.</p>
<div class="fragment"><div class="line"><a class="code" href="classAssemblyEmit.html">AssemblyEmit</a> *assememit = <span class="keyword">new</span> AssemblyRaw();</div><div class="line"></div><div class="line"><a class="code" href="classAddress.html">Address</a> addr(trans-&gt;<a class="code" href="classAddrSpaceManager.html#aec65c9fb56f10199463c70d5b6660b3f">getDefaultSpace</a>(),0x80484c0);</div><div class="line">int4 length;                  <span class="comment">// Length of instruction in bytes</span></div><div class="line"></div><div class="line">length = trans-&gt;<a class="code" href="classTranslate.html#ac97443bb89e0c6bfb68caf9f48a8c85d">printAssembly</a>(*assememit,addr);</div><div class="line">addr = addr + length;        <span class="comment">// Advance to next instruction</span></div><div class="line">length = trans-&gt;<a class="code" href="classTranslate.html#ac97443bb89e0c6bfb68caf9f48a8c85d">printAssembly</a>(*assememit,addr);</div><div class="line">addr = addr + length;</div><div class="line">length = trans-&gt;<a class="code" href="classTranslate.html#ac97443bb89e0c6bfb68caf9f48a8c85d">printAssembly</a>(*assememit,addr);</div></div><!-- fragment --><h1><a class="anchor" id="sleighpcodeemit"></a>
PcodeEmit</h1>
<p>In order to generate a <b>pcode</b> translation of a machine instruction, you need to derive a class from <a class="el" href="classPcodeEmit.html" title="Abstract class for emitting pcode to an application. ">PcodeEmit</a> and implement the virtual method <em>dump</em>. This method will be invoked once for each <b>pcode</b> operation in the translation of a machine instruction. There will likely be multiple calls per instruction. Each call passes in a single <b>pcode</b> operation, complete with its possible varnode output, and all of its varnode inputs. Here is an example of a <a class="el" href="classPcodeEmit.html" title="Abstract class for emitting pcode to an application. ">PcodeEmit</a> object that simply prints out the <b>pcode</b>.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>PcodeRawOut : <span class="keyword">public</span> <a class="code" href="classPcodeEmit.html">PcodeEmit</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classPcodeEmit.html#a00f25999bbdea677b82577b21bdfff8e">dump</a>(<span class="keyword">const</span> <a class="code" href="classAddress.html">Address</a> &amp;addr,<a class="code" href="opcodes_8hh.html#abeb7dfb0e9e2b3114e240a405d046ea7">OpCode</a> opc,<a class="code" href="structVarnodeData.html">VarnodeData</a> *outvar,<a class="code" href="structVarnodeData.html">VarnodeData</a> *vars,int4 isize);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_vardata(ostream &amp;s,<a class="code" href="structVarnodeData.html">VarnodeData</a> &amp;data)</div><div class="line"></div><div class="line">{</div><div class="line">  s &lt;&lt; <span class="charliteral">&#39;(&#39;</span> &lt;&lt; data.<a class="code" href="structVarnodeData.html#a1a69a5187f7a6376c0c93c08962ea68d">space</a>-&gt;<a class="code" href="classAddrSpace.html#a0ff86055617ff65ee8961b7c4e6caf98">getName</a>() &lt;&lt; <span class="charliteral">&#39;,&#39;</span>;</div><div class="line">  data.<a class="code" href="structVarnodeData.html#a1a69a5187f7a6376c0c93c08962ea68d">space</a>-&gt;<a class="code" href="classAddrSpace.html#aac551de6286f9260153c1d7d1bacdab8">printOffset</a>(s,data.<a class="code" href="structVarnodeData.html#a1a511384ee72e847b51423cc99c8233e">offset</a>);</div><div class="line">  s &lt;&lt; <span class="charliteral">&#39;,&#39;</span> &lt;&lt; dec &lt;&lt; data.<a class="code" href="structVarnodeData.html#a50d39ae46d51c8854b962f3ec4ee4e25">size</a> &lt;&lt; <span class="charliteral">&#39;)&#39;</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> PcodeRawOut::dump(<span class="keyword">const</span> <a class="code" href="classAddress.html">Address</a> &amp;addr,<a class="code" href="opcodes_8hh.html#abeb7dfb0e9e2b3114e240a405d046ea7">OpCode</a> opc,<a class="code" href="structVarnodeData.html">VarnodeData</a> *outvar,<a class="code" href="structVarnodeData.html">VarnodeData</a> *vars,int4 isize)</div><div class="line"></div><div class="line">{</div><div class="line">  <span class="keywordflow">if</span> (outvar != (<a class="code" href="structVarnodeData.html">VarnodeData</a> *)0) {     <span class="comment">// The output is optional</span></div><div class="line">    print_vardata(cout,*outvar);</div><div class="line">    cout &lt;&lt; <span class="stringliteral">&quot; = &quot;</span>;</div><div class="line">  }</div><div class="line">  cout &lt;&lt; <a class="code" href="opcodes_8hh.html#af739d367233d5c761457f782e249ce7a">get_opname</a>(opc);</div><div class="line">  <span class="comment">// Possibly check for a code reference or a space reference</span></div><div class="line">  <span class="keywordflow">for</span>(int4 i=0;i&lt;isize;++i) {</div><div class="line">    cout &lt;&lt; <span class="charliteral">&#39; &#39;</span>;</div><div class="line">    print_vardata(cout,vars[i]);</div><div class="line">  }</div><div class="line">  cout &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --><p>Notice that the <em>dump</em> routine uses the built-in function <em>get_opname</em> to find a string version of the opcode. Each varnode is defined in terms of the <a class="el" href="structVarnodeData.html" title="Data defining a specific memory location. ">VarnodeData</a> object, which is defined simply:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code" href="structVarnodeData.html">VarnodeData</a> {</div><div class="line">  <a class="code" href="classAddrSpace.html">AddrSpace</a> *<a class="code" href="structVarnodeData.html#a1a69a5187f7a6376c0c93c08962ea68d">space</a>;          <span class="comment">// The address space</span></div><div class="line">  uintb <a class="code" href="structVarnodeData.html#a1a511384ee72e847b51423cc99c8233e">offset</a>;              <span class="comment">// The offset within the space</span></div><div class="line">  uint4 <a class="code" href="structVarnodeData.html#a50d39ae46d51c8854b962f3ec4ee4e25">size</a>;                <span class="comment">// The number of bytes at that location</span></div><div class="line">};</div></div><!-- fragment --><p>Once the <a class="el" href="classPcodeEmit.html" title="Abstract class for emitting pcode to an application. ">PcodeEmit</a> object is instantiated, the <a class="el" href="classSleigh.html">Sleigh</a> object can use it to generate pcode, one instruction at a time, using the Translate::oneInstruction() const method.</p>
<div class="fragment"><div class="line"><a class="code" href="classPcodeEmit.html">PcodeEmit</a> *pcodeemit = <span class="keyword">new</span> PcodeRawOut();</div><div class="line"></div><div class="line"><a class="code" href="classAddress.html">Address</a> addr(trans-&gt;<a class="code" href="classAddrSpaceManager.html#aec65c9fb56f10199463c70d5b6660b3f">getDefaultSpace</a>(),0x80484c0);</div><div class="line">int4 length;                   <span class="comment">// Length of instruction in bytes</span></div><div class="line"></div><div class="line">length = trans-&gt;<a class="code" href="classTranslate.html#a1737782c38ee43de62ae2e7572321fc9">oneInstruction</a>(*pcodeemit,addr);</div><div class="line">addr = addr + length;         <span class="comment">// Advance to next instruction</span></div><div class="line">length = trans-&gt;<a class="code" href="classTranslate.html#a1737782c38ee43de62ae2e7572321fc9">oneInstruction</a>(*pcodeemit,addr);</div><div class="line">addr = addr + length;</div><div class="line">length = trans-&gt;<a class="code" href="classTranslate.html#a1737782c38ee43de62ae2e7572321fc9">oneInstruction</a>(*pcodeemit,addr);</div></div><!-- fragment --><p>For an application to properly <em>follow</em> <em>flow</em>, while translating machine instructions into pcode, the emitted pcode must be inspected for the various branch operations.</p>
<h1><a class="anchor" id="sleighloadimage"></a>
LoadImage</h1>
<p>A <a class="el" href="classLoadImage.html" title="An interface into a particular binary executable image. ">LoadImage</a> holds all the binary data from an executable file in the format similar to how it would exist when being executed by a real processor. The interface to this from SLEIGH is actually very simple, although it can hide a complicated structure. One method does most of the work, <a class="el" href="classLoadImage.html#af00d3957284bf0b4721be0ada5ef4328" title="Get data from the LoadImage. ">LoadImage::loadFill()</a>. It takes a byte pointer, a size, and an <a class="el" href="classAddress.html" title="A low-level machine address for labelling bytes and data. ">Address</a>. The method is expected to fill in the <em>ptr</em> array with <em>size</em> bytes taken from the load image, corresponding to the address <em>addr</em>. There are two more virtual methods that are required for a complete implementation of <a class="el" href="classLoadImage.html" title="An interface into a particular binary executable image. ">LoadImage</a>, <em>getArchType</em> and <em>adjustVma</em>, but these do not need to be implemented fully.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyLoadImage : <span class="keyword">public</span> <a class="code" href="classLoadImage.html">LoadImage</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  MyLoadImage(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;nm) : Loadimage(nm) {}</div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classLoadImage.html#af00d3957284bf0b4721be0ada5ef4328">loadFill</a>(uint1 *ptr,int4 size,<span class="keyword">const</span> <a class="code" href="classAddress.html">Address</a> &amp;addr);</div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">string</span> <a class="code" href="classLoadImage.html#a5103418147e95994f66e77746c0a0cfc">getArchType</a>(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="stringliteral">&quot;mytype&quot;</span>; }</div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classLoadImage.html#a51a254f705fba6f0e6524995acd5aaa7">adjustVma</a>(<span class="keywordtype">long</span> adjust) {}</div><div class="line">};</div></div><!-- fragment --><h1><a class="anchor" id="sleighcontext"></a>
ContextDatabase</h1>
<p>The <a class="el" href="classContextDatabase.html" title="An interface to a database of disassembly/decompiler context information. ">ContextDatabase</a> needs to keep track of any possible context variable and its value, over different address ranges. In most cases, you probably don't need to override the class yourself, but can use the built-in class, <a class="el" href="classContextInternal.html" title="An in-memory implementation of the ContextDatabase interface. ">ContextInternal</a>. This provides the basic functionality required and will work for different architectures. What you may need to do is set values for certain variables, depending on the processor and the environment it is running in. For instance, for the x86 platform, you need to set the <em>addrsize</em> and <em>opsize</em> bits, to indicate the processor would be running in 32-bit mode. The context variables specific to a particular processor are established by the SLEIGH spec. So the variables can only be set <em>after</em> the spec has been loaded.</p>
<div class="fragment"><div class="line">...</div><div class="line">context = <span class="keyword">new</span> <a class="code" href="classContextInternal.html">ContextInternal</a>();</div><div class="line">trans = <span class="keyword">new</span> <a class="code" href="classSleigh.html">Sleigh</a>(loader,context);</div><div class="line"><a class="code" href="classDocumentStorage.html">DocumentStorage</a> docstorage;</div><div class="line"><a class="code" href="classElement.html">Element</a> *root = docstorage.openDocument(<span class="stringliteral">&quot;specfiles/x86.sla&quot;</span>)-&gt;getRoot();</div><div class="line">docstorage.registerTag(root);</div><div class="line">trans-&gt;<a class="code" href="classTranslate.html#af8e71e9a9477e9a91be400ecca565df5">initialize</a>(docstorage);</div><div class="line"></div><div class="line">context-&gt;<a class="code" href="classContextDatabase.html#ad076227dbe22aad0f4a379e2f39ef488">setVariableDefault</a>(<span class="stringliteral">&quot;addrsize&quot;</span>,1);  <span class="comment">// Address size is 32-bits</span></div><div class="line">context-&gt;<a class="code" href="classContextDatabase.html#ad076227dbe22aad0f4a379e2f39ef488">setVariableDefault</a>(<span class="stringliteral">&quot;opsize&quot;</span>,1);    <span class="comment">// Operand size is 32-bits</span></div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
